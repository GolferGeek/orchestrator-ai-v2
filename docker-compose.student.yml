version: '3.8'

# Student Quick-Start Docker Compose Configuration
# Simplified setup with pre-seeded demo data and minimal configuration

services:
  # Supabase Local Instance with Demo Data
  supabase:
    image: supabase/cli:latest
    container_name: orchestrator-supabase-student
    volumes:
      - ./apps/api/supabase:/workspace/supabase
      - supabase-db-data-student:/var/lib/postgresql/data
    working_dir: /workspace/supabase
    # Start Supabase and seed demo data
    command: >
      sh -c "
      supabase start &&
      sleep 5 &&
      supabase db reset --with-seed &&
      tail -f /dev/null
      "
    ports:
      - "6010:6010"  # API
      - "6012:6012"  # Database
      - "6015:6015"  # Studio
      - "6016:6016"  # Inbucket (Email)
    environment:
      - SUPABASE_DB_PASSWORD=postgres
    networks:
      - orchestrator-network-student
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6010/health"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Ollama LLM Service with Pre-pulled Models
  ollama:
    image: ollama/ollama:latest
    container_name: orchestrator-ollama-student
    volumes:
      - ollama-data-student:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - orchestrator-network-student
    # Pull lightweight model on startup for students
    command: >
      sh -c "
      ollama serve &
      sleep 5 &&
      ollama pull llama3.2:1b || true &&
      wait
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # API Server
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: orchestrator-api-student
    ports:
      - "6100:6100"
    environment:
      - NODE_ENV=production
      - API_PORT=6100
      - SUPABASE_URL=http://supabase:6010
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      - SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU}
      - OLLAMA_BASE_URL=http://ollama:11434
      # Students can optionally add API keys for cloud models
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - ./apps/api:/app/apps/api
      - ./apps/transport-types:/app/apps/transport-types
    depends_on:
      supabase:
        condition: service_healthy
      ollama:
        condition: service_healthy
    networks:
      - orchestrator-network-student
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6100/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Web Application
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    container_name: orchestrator-web-student
    ports:
      - "7101:7101"
    environment:
      - NODE_ENV=production
      - VITE_API_BASE_URL=http://localhost:6100
      - VITE_SUPABASE_URL=http://localhost:6010
      - VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
    depends_on:
      - api
    networks:
      - orchestrator-network-student
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7101"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  supabase-db-data-student:
  ollama-data-student:

networks:
  orchestrator-network-student:
    driver: bridge
