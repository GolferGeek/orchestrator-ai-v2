{
  "organization_slug": "my-org",
  "slug": "agent_builder_chat",
  "display_name": "Agent Builder (Chat)",
  "agent_type": "function",
  "mode_profile": "conversation_only",
  "status": "active",
  "description": "Conversational agent builder - creates agents through natural chat with AI code generation",
  "yaml": "input_modes: ['text/plain']\noutput_modes: ['text/markdown', 'application/json']\ncapabilities: ['agent_creation', 'validation', 'conversation', 'code_generation']\n",
  "context": {
    "system": "You are a friendly Agent Builder assistant. You help users create agents through natural conversation, and you can generate function code automatically using AI."
  },
  "config": {
    "configuration": {
      "function": {
        "timeout_ms": 15000,
        "code": "module.exports = async (input, ctx) => {\n  const userMessage = input?.userMessage || input?.prompt || '';\n  const conversationState = input?.conversationState || {\n    step: 'welcome',\n    agentConfig: {},\n    needsInfo: []\n  };\n\n  const state = { ...conversationState };\n\n  // Helper functions\n  const extractAgentType = (msg) => {\n    const lower = msg.toLowerCase();\n    if (lower.includes('function')) return 'function';\n    if (lower.includes('context') || lower.includes('conversational')) return 'context';\n    if (lower.includes('api')) return 'api';\n    if (lower.includes('orchestrator')) return 'orchestrator';\n    return null;\n  };\n\n  const extractSlug = (msg) => {\n    const match = msg.match(/slug[:\\s]+([a-z0-9_-]+)/i);\n    return match ? match[1].toLowerCase().replace(/[^a-z0-9_-]/g, '_') : null;\n  };\n\n  const extractModes = (msg) => {\n    const modes = [];\n    if (msg.includes('json') || msg.includes('application/json')) modes.push('application/json');\n    if (msg.includes('text/plain') || msg.includes('plain text')) modes.push('text/plain');\n    if (msg.includes('markdown') || msg.includes('text/markdown')) modes.push('text/markdown');\n    return modes.length ? modes : null;\n  };\n\n  switch (state.step) {\n    case 'welcome':\n      if (!userMessage) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `# Welcome to Agent Builder! ü§ñ\n\nI'll help you create a new agent through conversation.\n\n**What would you like to build?**\n\nJust describe what you want:\n- \"Create a function agent that summarizes articles\"\n- \"I need an agent to answer customer FAQs\"\n- \"Build something that generates images\"\n\nWhat's your idea?`,\n          state: { ...state, step: 'collect_intent' }\n        };\n      }\n      state.step = 'collect_intent';\n\n    case 'collect_intent':\n      const agentType = extractAgentType(userMessage);\n      if (!agentType) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `I'm not sure what type. Please choose:\n- **Function** - Runs custom code\n- **Context** - Conversational with instructions\n- **API** - Calls external services\n- **Orchestrator** - Coordinates other agents`,\n          state\n        };\n      }\n\n      state.agentConfig.agent_type = agentType;\n      state.agentConfig.purpose = userMessage;\n      state.step = 'collect_basic_info';\n\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: `Perfect! A **${agentType} agent**! ‚ú®\n\nNow give it an identity:\n- **Slug** (e.g., article_summarizer)\n- **Display Name** (e.g., Article Summarizer)\n- **Description** (optional)\n\nExample: \"slug: article_summarizer, name: Article Summarizer, description: Summarizes long articles\"`,\n        state\n      };\n\n    case 'collect_basic_info':\n      const slug = extractSlug(userMessage) || \n        userMessage.split(',')[0]?.trim().toLowerCase().replace(/[^a-z0-9_-]/g, '_');\n      \n      if (!slug || slug.length < 3) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `I need a valid slug (3+ chars, lowercase with underscores).\n\nExample: \\`article_summarizer\\``,\n          state\n        };\n      }\n\n      const nameParts = userMessage.split(/name:|display name:/i);\n      const displayName = nameParts[1]?.split(/,|description:/i)[0]?.trim() || \n        slug.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n      \n      const descParts = userMessage.split(/description:/i);\n      const description = descParts[1]?.trim() || null;\n\n      state.agentConfig.slug = slug;\n      state.agentConfig.display_name = displayName;\n      state.agentConfig.description = description;\n      state.step = 'collect_io';\n\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: `Great!\n- **Slug:** ${slug}\n- **Name:** ${displayName}\n${description ? `- **Description:** ${description}` : ''}\n\n**What input/output formats?**\n\nExamples:\n- \"JSON input, markdown output\"\n- \"Plain text in, JSON out\"`,\n        state\n      };\n\n    case 'collect_io':\n      const inputModes = extractModes(userMessage);\n      const outputModes = extractModes(userMessage);\n\n      if (!inputModes || !outputModes) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `Please specify both.\n\nExample: \"JSON input, markdown output\"`,\n          state\n        };\n      }\n\n      state.agentConfig.yaml = `input_modes: ${JSON.stringify(inputModes)}\\noutput_modes: ${JSON.stringify(outputModes)}\\n`;\n      state.agentConfig.input_modes = inputModes;\n      state.agentConfig.output_modes = outputModes;\n      state.step = 'collect_config';\n\n      const agentType = state.agentConfig.agent_type;\n      let configPrompt = '';\n      \n      if (agentType === 'function') {\n        configPrompt = `Perfect! ‚úÖ\n\n**Now, describe what this function should do.**\n\nI'll generate the code for you automatically! Just tell me in plain language:\n\nExample:\n\"Take the input text, count the words, and return the count as JSON\"\n\nWhat should it do?`;\n      } else if (agentType === 'context') {\n        configPrompt = `Perfect! ‚úÖ\n\nProvide a **system prompt** - the instructions for this agent.\n\nExample:\n\"You are a helpful customer service agent. Answer questions politely.\"`;\n      } else if (agentType === 'api') {\n        configPrompt = `Perfect! ‚úÖ\n\nProvide:\n1. **Endpoint URL**\n2. **HTTP Method** (GET, POST, etc.)\n\nExample: \"endpoint: https://api.example.com/data, method: GET\"`;\n      }\n\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: configPrompt,\n        state\n      };\n\n    case 'collect_config':\n      const agentTypeConfig = state.agentConfig.agent_type;\n\n      if (agentTypeConfig === 'function') {\n        // AI CODE GENERATION: Use LLM to generate function code\n        const description = userMessage.trim();\n        \n        if (description.length < 10) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: 'Please provide a more detailed description (at least 10 characters).',\n            state\n          };\n        }\n\n        try {\n          // Generate code using AI\n          const codeGen = await ctx.services.agentBuilder.generateFunctionCode(\n            description,\n            state.agentConfig.input_modes,\n            state.agentConfig.output_modes\n          );\n\n          if (codeGen.error || !codeGen.code) {\n            return {\n              ok: true,\n              format: 'text/markdown',\n              content: `‚ùå Code generation failed: ${codeGen.error || 'Unknown error'}\n\nPlease try describing what you want differently.`,\n              state\n            };\n          }\n\n          // Default timeout\n          const timeout = 10000;\n\n          state.agentConfig.config = {\n            configuration: {\n              function: {\n                timeout_ms: timeout,\n                code: codeGen.code\n              }\n            }\n          };\n\n          state.generatedCode = codeGen.code;\n          state.step = 'validate';\n\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: `‚ú® **Code generated!**\n\nValidating now...`,\n            state,\n            action: 'auto_validate'\n          };\n        } catch (error) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: `‚ùå Error generating code: ${error.message}`,\n            state\n          };\n        }\n      } else if (agentTypeConfig === 'context') {\n        const systemPrompt = userMessage.trim();\n        if (systemPrompt.length < 10) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: 'Please provide a more detailed system prompt (at least 10 characters).',\n            state\n          };\n        }\n\n        state.agentConfig.context = {\n          system: systemPrompt\n        };\n        state.step = 'validate';\n\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: 'Got it! Validating...',\n          state,\n          action: 'auto_validate'\n        };\n      } else if (agentTypeConfig === 'api') {\n        const endpointMatch = userMessage.match(/endpoint[:\\s]+([^,\\n]+)/i);\n        const methodMatch = userMessage.match(/method[:\\s]+([A-Z]+)/i);\n\n        const endpoint = endpointMatch?.[1]?.trim();\n        const method = methodMatch?.[1]?.toUpperCase() || 'GET';\n\n        if (!endpoint) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: 'Please provide an endpoint URL.',\n            state\n          };\n        }\n\n        state.agentConfig.config = {\n          configuration: {\n            api: {\n              api_configuration: {\n                endpoint: endpoint,\n                method: method\n              }\n            }\n          }\n        };\n        state.step = 'validate';\n\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: 'Got it! Validating...',\n          state,\n          action: 'auto_validate'\n        };\n      }\n\n    case 'validate':\n      try {\n        const validation = await ctx.services.agentBuilder.validate(state.agentConfig);\n        state.validationResults = validation;\n\n        if (!validation.ok) {\n          const issues = validation.issues.map(i => `‚ùå ${i.message}`).join('\\n');\n          \n          // For function agents, show the generated code\n          const codePreview = state.generatedCode \n            ? `\\n\\n**Generated Code:**\\n\\`\\`\\`javascript\\n${state.generatedCode.substring(0, 300)}...\\n\\`\\`\\`\\n`\n            : '';\n\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: `## Validation Issues\n\n${issues}${codePreview}\n\nWould you like to try again? (Reply \"yes\" or \"no\")`,\n            state,\n            failed: true\n          };\n        }\n\n        state.step = 'confirm';\n        const dryRunStatus = validation.dryRun \n          ? (validation.dryRun.ok ? '‚úÖ Dry-run: **PASSED**' : '‚ö†Ô∏è Dry-run: **FAILED**')\n          : '';\n\n        // Show generated code for function agents\n        const codePreview = state.generatedCode\n          ? `\\n**Generated Code Preview:**\\n\\`\\`\\`javascript\\n${state.generatedCode.substring(0, 400)}\\n${state.generatedCode.length > 400 ? '...' : ''}\\n\\`\\`\\`\\n`\n          : '';\n\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `## ‚úÖ Validation Successful!\n\n**Agent Details:**\n- **Type:** ${state.agentConfig.agent_type}\n- **Slug:** ${state.agentConfig.slug}\n- **Name:** ${state.agentConfig.display_name}\n- **Input:** ${state.agentConfig.input_modes?.join(', ')}\n- **Output:** ${state.agentConfig.output_modes?.join(', ')}\n\n**Validation Results:**\n‚úÖ Schema validation passed\n‚úÖ Policy checks passed\n${dryRunStatus}\n${codePreview}\n**Ready to create?** (Reply \"yes\" to create or \"no\" to cancel)`,\n          state\n        };\n      } catch (error) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `‚ùå Validation error: ${error.message}\n\nWould you like to try again? (Reply \"yes\" or \"no\")`,\n          state,\n          failed: true\n        };\n      }\n\n    case 'confirm':\n      const confirmed = userMessage.toLowerCase().includes('yes') || \n        userMessage.toLowerCase().includes('create') ||\n        userMessage.toLowerCase().includes('proceed');\n\n      if (!confirmed) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `Agent creation cancelled.\n\nWant to start over? Say \"create an agent\"!`,\n          state: { step: 'welcome', agentConfig: {} }\n        };\n      }\n\n      state.step = 'create';\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: 'üöÄ Creating your agent...',\n        state,\n        action: 'auto_create'\n      };\n\n    case 'create':\n      try {\n        const result = await ctx.services.agentBuilder.create(state.agentConfig);\n        \n        if (!result.success) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: `‚ùå Creation failed: ${result.error}\n\nWould you like to try again?`,\n            state\n          };\n        }\n\n        return {\n          ok: true,\n          format: 'application/json',\n          content: {\n            success: true,\n            message: `üéâ Success! Agent **${state.agentConfig.display_name}** created!\n\n**Agent ID:** ${result.data.id}\n**Status:** draft\n\nThe agent is ready for testing. Create another?`,\n            agentId: result.data.id,\n            agentSlug: state.agentConfig.slug\n          },\n          state: { step: 'complete', agentId: result.data.id }\n        };\n      } catch (error) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `‚ùå Error: ${error.message}\n\nTry again?`,\n          state\n        };\n      }\n\n    case 'complete':\n      const wantsAnother = userMessage.toLowerCase().includes('yes') ||\n        userMessage.toLowerCase().includes('another') ||\n        userMessage.toLowerCase().includes('create');\n\n      if (wantsAnother) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `# Let's create another! ü§ñ\n\nWhat kind of agent?`,\n          state: { step: 'collect_intent', agentConfig: {} }\n        };\n      }\n\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: `Thanks for using Agent Builder! üëã`,\n        state\n      };\n\n    default:\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: `# Welcome to Agent Builder! ü§ñ\n\nTell me what you want to build!`,\n        state: { step: 'collect_intent', agentConfig: {} }\n      };\n  }\n};"
      }
    }
  }
}
