{
  "organization_slug": "my-org",
  "slug": "agent_builder_orchestrator_v2",
  "display_name": "Agent Builder Orchestrator v2",
  "agent_type": "function",
  "mode_profile": "full_cycle",
  "description": "Guides users through agent creation with real validation and API integration",
  "yaml": "input_modes: ['application/json', 'text/plain']\noutput_modes: ['application/json', 'text/markdown']\ncapabilities: ['agent_creation', 'validation', 'human_approval']\n",
  "context": {
    "system": "You are the Agent Builder Orchestrator v2. You guide users through creating well-designed agents with real validation and creation services."
  },
  "config": {
    "configuration": {
      "function": {
        "timeout_ms": 15000,
        "code": "module.exports = async (input, ctx) => {\n  // Agent Builder Orchestrator v2 - Uses real validation and creation services\n  const { step, data, conversationState } = input;\n  \n  const state = conversationState || {\n    step: 'intent',\n    agentConfig: {},\n    validationResults: null\n  };\n\n  switch (step || state.step) {\n    case 'intent':\n      if (!data?.agentType || !data?.purpose) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: '## Welcome to Agent Builder\\n\\nLet\\'s create a new agent! First, tell me:\\n1. What type of agent? (function, context, api, orchestrator)\\n2. What should this agent do?',\n          state: { ...state, step: 'intent' },\n          needsInput: true\n        };\n      }\n      state.agentConfig.agent_type = data.agentType;\n      state.agentConfig.purpose = data.purpose;\n      state.step = 'basic_info';\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: `Great! A **${data.agentType}** agent for: ${data.purpose}\\n\\nNow provide:\\n- Organization slug (or leave blank for global)\\n- Agent slug (lowercase, underscores)\\n- Display name\\n- Description`,\n        state,\n        needsInput: true\n      };\n\n    case 'basic_info':\n      if (!data?.slug || !data?.displayName) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: 'Please provide the required fields: slug and displayName',\n          state,\n          needsInput: true\n        };\n      }\n      state.agentConfig.organization_slug = data.organizationSlug || null;\n      state.agentConfig.slug = data.slug;\n      state.agentConfig.display_name = data.displayName;\n      state.agentConfig.description = data.description || null;\n      state.step = 'io_contract';\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: `## IO Contract\\n\\nDefine input and output modes for **${data.displayName}**:\\n\\nInput modes (e.g., application/json, text/plain):\\nOutput modes (e.g., text/markdown, application/json):`,\n        state,\n        needsInput: true\n      };\n\n    case 'io_contract':\n      if (!data?.inputModes || !data?.outputModes) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: 'Please provide both inputModes and outputModes as arrays',\n          state,\n          needsInput: true\n        };\n      }\n      const yaml = `input_modes: ${JSON.stringify(data.inputModes)}\\noutput_modes: ${JSON.stringify(data.outputModes)}\\n`;\n      state.agentConfig.yaml = yaml;\n      state.step = 'agent_config';\n      \n      const type = state.agentConfig.agent_type;\n      let configPrompt = '';\n      if (type === 'function') {\n        configPrompt = '## Function Configuration\\n\\nProvide:\\n- timeout_ms (max 30000)\\n- code (JavaScript module.exports function)';\n      } else if (type === 'context') {\n        configPrompt = '## Context Configuration\\n\\nProvide:\\n- system prompt (instructions for the agent)';\n      } else if (type === 'api') {\n        configPrompt = '## API Configuration\\n\\nProvide:\\n- endpoint URL\\n- HTTP method\\n- request/response transforms';\n      }\n      \n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: configPrompt,\n        state,\n        needsInput: true\n      };\n\n    case 'agent_config':\n      const agentType = state.agentConfig.agent_type;\n      \n      if (agentType === 'function') {\n        if (!data?.code || !data?.timeoutMs) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: 'Please provide both code and timeoutMs',\n            state,\n            needsInput: true\n          };\n        }\n        state.agentConfig.config = {\n          configuration: {\n            function: {\n              timeout_ms: data.timeoutMs,\n              code: data.code\n            }\n          }\n        };\n      } else if (agentType === 'context') {\n        if (!data?.systemPrompt) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: 'Please provide a system prompt',\n            state,\n            needsInput: true\n          };\n        }\n        state.agentConfig.context = {\n          system: data.systemPrompt\n        };\n      } else if (agentType === 'api') {\n        if (!data?.endpoint || !data?.method) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: 'Please provide endpoint and method',\n            state,\n            needsInput: true\n          };\n        }\n        state.agentConfig.config = {\n          configuration: {\n            api: {\n              api_configuration: {\n                endpoint: data.endpoint,\n                method: data.method\n              }\n            }\n          }\n        };\n      }\n      \n      state.step = 'validate';\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: '## Validation\\n\\nRunning validation checks...\\n\\nReady to validate. Proceed?',\n        state,\n        action: 'validate',\n        needsInput: false\n      };\n\n    case 'validate':\n      // Use real validation service\n      try {\n        const validation = await ctx.services.agentBuilder.validate(state.agentConfig);\n        state.validationResults = validation;\n        state.step = 'review';\n        \n        if (!validation.ok) {\n          const issues = validation.issues.map(i => `- ${i.message}`).join('\\n');\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: `## Validation Failed\\n\\n${issues}\\n\\nPlease go back and fix these issues.`,\n            state,\n            needsInput: true\n          };\n        }\n        \n        const dryRunStatus = validation.dryRun ? (validation.dryRun.ok ? '✅ Dry-run successful' : '❌ Dry-run failed') : '';\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `## Validation Results\\n\\n✅ Schema validation passed\\n✅ Policy checks passed\\n${dryRunStatus}\\n\\nReady to create **${state.agentConfig.display_name}**?`,\n          state,\n          needsInput: true\n        };\n      } catch (error) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `## Validation Error\\n\\n${error.message}\\n\\nPlease try again.`,\n          state,\n          needsInput: true\n        };\n      }\n\n    case 'review':\n      if (data?.approved !== true) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: 'Please confirm approval to create the agent',\n          state,\n          needsInput: true\n        };\n      }\n      state.step = 'create';\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: 'Creating agent via API...',\n        state,\n        action: 'create',\n        needsInput: false\n      };\n\n    case 'create':\n      // Use real creation service\n      try {\n        const result = await ctx.services.agentBuilder.create(state.agentConfig);\n        if (!result.success) {\n          return {\n            ok: true,\n            format: 'text/markdown',\n            content: `## Creation Failed\\n\\n${result.error}\\n\\nPlease try again.`,\n            state,\n            needsInput: true\n          };\n        }\n        \n        return {\n          ok: true,\n          format: 'application/json',\n          content: {\n            success: true,\n            message: `Agent **${state.agentConfig.display_name}** created successfully!`,\n            agentId: result.data.id,\n            config: state.agentConfig\n          },\n          state: { ...state, step: 'complete', agentId: result.data.id }\n        };\n      } catch (error) {\n        return {\n          ok: true,\n          format: 'text/markdown',\n          content: `## Creation Error\\n\\n${error.message}\\n\\nPlease try again.`,\n          state,\n          needsInput: true\n        };\n      }\n\n    default:\n      return {\n        ok: true,\n        format: 'text/markdown',\n        content: 'Unknown step. Please start over.',\n        state: { step: 'intent', agentConfig: {} },\n        needsInput: true\n      };\n  }\n};"
      }
    }
  }
}