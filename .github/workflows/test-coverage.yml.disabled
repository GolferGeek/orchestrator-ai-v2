name: Test Coverage & Quality

on:
  push:
    branches: [ main, davids-goliath ]
  pull_request:
    branches: [ main, davids-goliath ]

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install frontend dependencies
      working-directory: ./apps/web
      run: npm ci
      
    - name: Install backend dependencies  
      working-directory: ./apps/api
      run: npm ci
      
    - name: Run frontend unit tests with coverage
      working-directory: ./apps/web
      run: npm run test:unit -- --coverage --run
      continue-on-error: true
      
    - name: Run backend unit tests
      working-directory: ./apps/api
      run: npm test
      continue-on-error: true
      
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./apps/web/coverage/coverage-final.json
        flags: frontend
        name: frontend-coverage
        
    - name: Coverage comment
      uses: 5monkeys/cobertura-action@master
      with:
        path: ./apps/web/coverage/cobertura-coverage.xml
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        minimum_coverage: 75
        fail_below_threshold: false
        show_missing: true
        
    - name: Store coverage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ./apps/web/coverage/
        
  e2e-critical:
    runs-on: ubuntu-latest
    needs: test-coverage
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install frontend dependencies
      working-directory: ./apps/web
      run: npm ci
      
    - name: Install backend dependencies
      working-directory: ./apps/api
      run: npm ci
      
    - name: Start backend server
      working-directory: ./apps/api
      run: npm run start:dev &
      
    - name: Wait for backend
      run: sleep 30
      
    - name: Start frontend server
      working-directory: ./apps/web  
      run: npm run dev:http &
      
    - name: Wait for frontend
      run: sleep 15
      
    - name: Run critical E2E tests
      working-directory: ./apps/web
      run: npm run test:e2e -- --spec "tests/e2e/specs/basic-validation.cy.ts,tests/e2e/specs/authentication.cy.ts"
      continue-on-error: true
      
  quality-gates:
    runs-on: ubuntu-latest
    needs: [test-coverage, e2e-critical]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install frontend dependencies
      working-directory: ./apps/web
      run: npm ci
      
    - name: Run linting
      working-directory: ./apps/web
      run: npm run lint
      continue-on-error: true
      
    - name: Run type checking
      working-directory: ./apps/web
      run: npx vue-tsc --noEmit
      continue-on-error: true
      
    - name: Check bundle size
      working-directory: ./apps/web
      run: |
        npm run build
        npx bundlesize
      continue-on-error: true
      
    - name: Security audit
      run: |
        npm audit --audit-level moderate
        cd apps/web && npm audit --audit-level moderate
        cd ../api && npm audit --audit-level moderate
      continue-on-error: true